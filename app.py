import os
import shutil
import time
import pyfiglet
import streamlit as st
from Extract.url_app import URL_detector
from Extract.PE_app import PE_scanner


def run_PE():
    file = input("Enter the path and name of the file: ")
    os.system(f"python Extract/PE_main.py {file}")


def run_URL():
    os.system('python Extract/url_main.py')


def exit():
    os.system('exit')


def start():
    st.header('Welcome to antimalware detector')

    URL_tab, PE_tab = st.tabs(['URL detector', 'PE detector'])

    with URL_tab:
        st.markdown('## URL scanner:')
        url_detector = URL_detector()
        URL = st.text_input('Enter the URL for scanning:')
        if URL:
            with st.spinner('Wait for it...'):
                url_result = url_detector.scan_url(URL)
                if url_result == 'good':
                    st.success(url_result, icon="âœ…")
                else:
                    st.warning(url_result, icon='ðŸš¨')

    with PE_tab:
        st.markdown('## PE scanner:')
        upload_files = st.file_uploader(
            'Choose files: ', accept_multiple_files=True, type=None)
        pe_scanner = PE_scanner()
        if len(upload_files):
            if not os.path.exists('TestFile\\temp'):
                os.mkdir('TestFile\\temp')
            with st.spinner("Checking files..."):
                for i in upload_files:
                    with open(f'TestFile\\temp\\temp_{i.id}', 'wb') as file:
                        file.write(i.getvalue())
                        legitimate = pe_scanner.PE_scan(
                            f'TestFile\\temp\\temp_{i.id}')
                        if legitimate:
                            st.success(
                                f"File {i.name} is benign.", icon="âœ…")
                        else:
                            mal_class = pe_scanner.PE_mal_classify(
                                f'TestFile\\temp\\temp_{i.id}')
                            st.warning(
                                f"File {i.name} is malicious. The malware is most likely belongs to {mal_class}", icon='ðŸš¨')
                    file.close()
                shutil.rmtree(f'TestFile\\temp')


start()
